<!DOCTYPE html>
<html>
<head>
    <title>Control Panel</title>
    <link rel="stylesheet" type="text/css" href="control_panel.css">
</head>
<body>

    {% macro render_plugin(plugin_name, plugin) %}
        <div class="plugin">
            <h4>{{ plugin_name }}</h4>
            <form id="plugin-form-{{ plugin.id }}" action="/start/{{plugin.id}}" method="post">
                {% for arg in plugin.arguments %}
                    <label for="{{ plugin.id + '.' + arg.name }}">{{ arg.name }}:</label>
                    {% if arg['ui_element'] == 'textbox' %}
                        <input type="text" id="{{ plugin.id + '.' + arg.name }}" name="{{ arg.name }}"
                               value="{{ arg.default }}"
                               min={% if arg.get('min') is not none %}min="{{ arg.get('min') }}"{% endif %} DO IT LIKE DIS
                               max={% if arg.get('max') is not none %}min="{{ arg.get('max') }}"{% endif %}
                               required="{{ 'required' if arg.required else 'optional' }}">
                    {% elif arg['ui_element'] == 'slider' %}
                        <input type="range" id="{{ plugin.id + '.' + arg.name }}" name="{{ arg.name }}"
                               min="{{ arg.get('min', None) }}"
                               max="{{ arg.get('max', None) }}"
                               value="{{ arg.default }}">
                    {% elif arg['ui_element'] == 'checkbox' %}
                        <input type="checkbox" id="{{ plugin.id + '.' + arg['name']}}" name="{{ arg.name }}"
                               {% if arg['default'] %}checked{% endif %}>
                    <!-- Add other UI elements as needed -->
                    {% endif %}
                {% endfor %}
                <button type="submit">Start</button>
                <button type="button" onclick="stop('{{ plugin.id }}')">Stop</button>
            </form>
            <div class="tooltip">
                <span class="tooltiptext">{{ plugin.doc }}</span>
            </div>
        </div>
    {% endmacro %}

    {% macro render_plugins(metadata) %}
        {% for key, value in metadata.items() %}
            {% if "is_plugin" in value %}
                {{ render_plugin(key, value) }}
            {% else %}
                <div class="category">
                    <h3>{{ key }}</h3>
                    {{ render_plugins(value) }}
                </div>
            {% endif %}
        {% endfor %}
    {% endmacro %}

    <div class="plugins">
        {{ render_plugins(metadata) }}
    </div>

    <script>

    function stop(plugin) {
        fetch(`/stop/${plugin}`, { method: 'GET' })
            .then(response => response.json())
            .then(response => {
                console.log(response);
                checkStatusAndUpdateLight(plugin);
                })
            .catch(error => console.error('Error:', error));
    }

    function checkStatusAndUpdateLight(plugin) {
        fetch(`/status/${plugin}`, { method: 'GET' })
            .then(res => res.json())
            .then(res => {
                console.log(res);

                const statusLight = document.getElementById(plugin + '_statusLight');
                if (res.running) {
                    statusLight.classList.remove('red');
                    statusLight.classList.add('blue');
                } else {
                    statusLight.classList.remove('blue');
                    statusLight.classList.add('red');
                }

                const lastRunTimestamp = document.getElementById(`${plugin}_lastRunTimestamp`);
                lastRunTimestamp.textContent = `Last Run Time: ${res.lastRunTimestamp}`;
            })
            .catch(error => {
                console.error('Error:', error);
                statusLight.classList.remove('blue');
                statusLight.classList.add('red');
            });
    }
    {% for plugin in plugins %}
    setInterval(() => checkStatusAndUpdateLight('{{ plugin }}'), 5000);
    {% endfor %}

</script>
</body>
</html>
