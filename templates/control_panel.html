<!DOCTYPE html>
<html>
<head>
    <title>Control Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='control_panel.css') }}">
    <script src="{{ url_for('static', filename='control_panel.js') }}"></script>
</head>
<body>

    {% macro render_textbox(plugin_id, arg) %}
        <input type="text" id="{{ plugin_id + '.' + arg.name }}" name="{{ arg.name }}"
            value="{{ arg.default }}"
            min={% if arg.get('min') is not none %}min="{{ arg.get('min') }}"{% endif %}
            max={% if arg.get('max') is not none %}min="{{ arg.get('max') }}"{% endif %}
            required="{{ 'required' if arg.required else 'optional' }}">
    {% endmacro %}

    {% macro render_slider(plugin_id, arg) %}
        <input type="range" id="{{ plugin.id + '.' + arg.name }}" name="{{ arg.name }}"
            min="{{ arg.get('min', None) }}"
            max="{{ arg.get('max', None) }}"
            value="{{ arg.default }}">
    {% endmacro %}

    {% macro render_checkbox(plugin_id, arg) %}
        <input type="checkbox" id="{{ plugin.id + '.' + arg.name}}" name="{{ arg.name }}"
            {% if arg.default %}checked{% endif %}>
    {% endmacro %}

    {% macro render_plugin(plugin_name, plugin) %}
        <div class="plugin">
            <h4>{{ plugin_name }}</h4>
            <form id="plugin-form-{{ plugin.id }}" action="/start/{{plugin.id}}" method="post">
                {% for arg in plugin.arguments %}
                    <label for="{{ plugin.id + '.' + arg.name }}">{{ arg.name }}:</label>
                    {% if arg['ui_element'] == 'textbox' %}
                        {{ render_textbox(plugin.id, arg) }}
                    {% elif arg['ui_element'] == 'slider' %}
                        {{ render_slider(plugin.id, arg) }}
                    {% elif arg['ui_element'] == 'checkbox' %}
                        {{ render_checkbox(plugin.id, arg) }}
                    {% endif %}
                    <!-- Add other UI elements as needed -->
                {% endfor %}
                <button type="submit">Start</button>
                <button type="button" onclick="stop('{{ plugin.id }}')">Stop</button>
            </form>
            <div class="tooltip">
                <span class="tooltiptext">{{ plugin.doc }}</span>
            </div>
        </div>
    {% endmacro %}

    {% macro render_plugins(metadata) %}
        {% for key, value in metadata.items() %}
            {% if "is_plugin" in value %}
                {{ render_plugin(key, value) }}
            {% else %}
                <div class="category">
                    <h3>{{ key }}</h3>
                    {{ render_plugins(value) }}
                </div>
            {% endif %}
        {% endfor %}
    {% endmacro %}

    <div class="plugins">
        {{ render_plugins(metadata) }}
    </div>

    <script>
        {% for plugin in plugins %}
        setInterval(() => checkStatusAndUpdateLight('{{ plugin }}'), 5000);
        {% endfor %}
    </script>
</body>
</html>
